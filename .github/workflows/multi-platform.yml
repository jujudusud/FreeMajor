name: FreeMajor Multi-Platform ✅

on: [push, pull_request, release]

jobs:
  build:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            name: "Linux-x86_64"
            os: linux
          - runner: macos-15-intel  
            name: "macOS-Intel"
            os: macos
          - runner: macos-15
            name: "macOS-ARM64"
            os: macos
          - runner: windows-latest
            name: "Windows-x64"
            os: windows

    steps:
    - uses: actions/checkout@v4
      with: { submodules: recursive }

    # Linux - Dépendances EXACTES du README
    - name: Linux dependencies
      if: matrix.os == 'linux'
      run: |
        sudo apt update
        sudo apt install -y cmake build-essential libasound2-dev \
          libjack-jackd2-dev libfltk1.3-dev gettext git

    # macOS - Homebrew
    - name: macOS dependencies  
      if: matrix.os == 'macos'
      run: brew install cmake fltk gettext

    # Windows - RIEN (Visual Studio préinstallé)

    # Configuration CMake PAR PLATFORM
    - name: Configure CMake
      run: |
        case "${{ matrix.os }}" in
          linux|macos)
            cmake -B build -DCMAKE_BUILD_TYPE=Release -S .
            ;;
          windows)
            cmake -B build -G "Visual Studio 17 2022" -A x64 -S .
            ;;
        esac

    # Build
    - name: Build
      run: |
        case "${{ matrix.os }}" in
          linux|macos)
            cmake --build build
            ;;
          windows)
            cmake --build build --config Release
            ;;
        esac

    # Vérification binaire
    - name: Verify binary
      run: |
        if [[ "${{ matrix.os }}" == "windows" ]]; then
          ls -la build/Release/FreeMajor.exe || true
        else
          ls -la build/FreeMajor || true
          file build/FreeMajor || true
        fi

    # Release artifacts
    - name: Package release
      if: startsWith(github.ref, 'refs/tags/')
      shell: bash
      run: |
        BINARY="build/${{ matrix.os == 'windows' && 'Release/FreeMajor.exe' || 'FreeMajor' }}"
        if [[ -f "$BINARY" ]]; then
          cp "$BINARY" "FreeMajor-${{ matrix.name }}"
          zip -r "FreeMajor-${{ matrix.name }}-${{ github.ref_name }}.zip" "FreeMajor-${{ matrix.name }}"
        fi
